<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>모의대화 코칭 - SumTech</title>

  <!-- ⬇️ 첫번째 코드의 스타일을 이식했습니다. 기능/엔드포인트는 변경하지 않았습니다. -->
  <style>
    :root{--bg:#0b1020;--fg:#e6edf3;--muted:#9aa4b2;--card:#121a31;--border:#22304d;--accent:#6aa0ff;--warn:#f5a524}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic}
    header{padding:14px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(11,16,32,.9);backdrop-filter:saturate(1.2) blur(6px)}
    h1{margin:0;font-size:18px}
    .wrap{max-width:960px;margin:16px auto;padding:0 12px 28px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px}
    .pad{padding:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    select,input{width:100%;background:#0f1730;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none}
    .btn{background:#162446;border:1px solid var(--border);color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:#5b8fee;color:#0b1020;font-weight:600}
    .btn.warn{background:var(--warn);border-color:#e89519;color:#0b1020;font-weight:600}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .chat{display:flex;flex-direction:column;gap:10px;height:60vh;padding:14px;overflow:auto}
    .msg{max-width:85%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);white-space:pre-wrap;line-height:1.45}
    .msg.user{margin-left:auto;background:#13223f}
    .msg.bot{margin-right:auto;background:#111b34}
    .msg.sys{margin:6px auto 0 auto;background:#0f1730;border-style:dashed;color:var(--muted);font-size:12px}
    .small{font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .row-end{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .sep{height:1px;background:var(--border);margin:10px 0}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(880px,92vw);max-height:80vh;overflow:auto;background:#0f1730;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .modal .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .modal .bd{padding:14px}
    .modal .hd h3{margin:0;font-size:16px}
    .markdown h1,.markdown h2,.markdown h3{margin:.6em 0 .3em}
    .markdown p,.markdown li{line-height:1.55}
    .markdown code{background:#111b34;padding:.1em .35em;border-radius:6px}
    .markdown pre{background:#111b34;padding:10px;border-radius:10px;overflow:auto}
    .markdown ul{padding-left:20px}
  </style>

  <!-- 기존 외부 스타일은 유지 (기능 영향 없음) -->
  <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <a href="index.html" style="text-decoration: none;">
          <span class="logo-text">SumTech</span>
        </a>
      </div>
      <ul class="nav-menu">
        <li><a href="/" class="nav-link">홈</a></li>
        <li><a href="/scan/voice" class="nav-link">통화위험체크</a></li>
        <li><a href="/scan/message" class="nav-link">메세지 위협체크</a></li>
        <li><a href="/api/chat-bot" class="nav-link active">모의대화 코칭</a></li>
        <li><a href="service4.html" class="nav-link">상황 퀴즈</a></li>
      </ul>
    </div>
  </nav>

  <!-- Service Detail Hero -->
  <section class="service-detail-hero">
    <div class="container">
      <h1>모의대화 코칭</h1>
      <p class="hero-subtitle">실제 보이스피싱 시나리오로 대화하며 올바른 대응법을 배웁니다</p>
    </div>
  </section>

  <!-- Chat Simulation Section -->
  <section class="chat-simulation-section">
    <div class="container">
      <div class="simulation-wrapper">
        <!-- Left Panel - Settings -->
        <div class="simulation-sidebar">
          <div class="sidebar-section">
            <label class="sidebar-label">시나리오</label>
            <div class="custom-select-wrapper">
              <select id="scenarioSelect" class="custom-select">
                <option value="">시나리오 선택</option>
                <option value="scenario1">택배 배송 사칭</option>
                <option value="scenario2">금융감독원 사칭</option>
                <option value="scenario3">경찰청 사칭</option>
                <option value="scenario4">가족 사칭</option>
                <option value="scenario5">은행원 사칭</option>
              </select>
              <i class="fas fa-chevron-down select-arrow"></i>
            </div>
          </div>

          <div class="sidebar-section">
            <label class="sidebar-label">오프닝(첫 선 멘트)</label>
            <div class="opening-preview" id="openingPreview">
              시나리오를 선택하면 오프닝 멘트가 표시됩니다.
            </div>
          </div>

          <button class="btn btn-accent btn-full" id="startSimulationBtn">
            <i class="fas fa-phone-alt"></i>
            전화 연결(첫 선 멘트)
          </button>

          <button class="btn btn-outline btn-full" id="viewResultBtn" style="margin-top: 1rem;">
            <i class="fas fa-chart-bar"></i>
            결과 보러가기
          </button>

          <div class="sidebar-info">
            <h4><i class="fas fa-info-circle"></i> 개인정보 입력 금지</h4>
            <p>실제 개인정보는 절대 입력하지 마세요.</p>
            <p class="info-detail">시뮬레이션 목적으로만 사용하세요.</p>
          </div>
        </div>

        <!-- Right Panel - Chat Interface -->
        <div class="simulation-chat">
          <div class="chat-header">
            <div class="chat-status">
              <i class="fas fa-circle" id="chatStatusIcon"></i>
              <span id="chatStatusText">대기 중...</span>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div class="chat-welcome">
              <i class="fas fa-shield-alt"></i>
              <h3>보이스피싱 시뮬레이션에 오신 것을 환영합니다</h3>
              <p>왼쪽에서 시나리오를 선택하고 '전화 연결' 버튼을 눌러 시작하세요.</p>
              <div class="welcome-tips">
                <div class="tip-item">
                  <i class="fas fa-check-circle"></i>
                  <span>실제 보이스피싱 대화를 시뮬레이션합니다</span>
                </div>
                <div class="tip-item">
                  <i class="fas fa-check-circle"></i>
                  <span>어떻게 대응하는지 평가하고 피드백을 제공합니다</span>
                </div>
                <div class="tip-item">
                  <i class="fas fa-check-circle"></i>
                  <span>실제 개인정보는 절대 입력하지 마세요</span>
                </div>
              </div>
            </div>
          </div>

          <div class="chat-input-wrapper">
            <textarea 
              id="chatInput" 
              placeholder="메시지를 입력하세요 (Enter 전송)"
              rows="1"
              disabled
            ></textarea>
            <button class="btn btn-primary chat-send-btn" id="sendMessageBtn" disabled>
              전송
            </button>
          </div>

          <div class="chat-footer">
            <span>시뮬레이션 모드</span>
            <span class="divider">|</span>
            <span>로컬 실행</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- How It Works Section -->
  <section class="how-it-works-section">
    <div class="container">
      <h2>시뮬레이션 진행 방법</h2>
      <div class="steps-grid">
        <div class="step-card">
          <div class="step-number">1</div>
          <h3>시나리오 선택</h3>
          <p>다양한 보이스피싱 유형 중 하나를 선택합니다</p>
        </div>
        <div class="step-card">
          <div class="step-number">2</div>
          <h3>대화 시작</h3>
          <p>AI가 실제 보이스피싱범처럼 대화를 시작합니다</p>
        </div>
        <div class="step-card">
          <div class="step-number">3</div>
          <h3>대응 연습</h3>
          <p>직접 메시지를 입력하며 대응 방법을 연습합니다</p>
        </div>
        <div class="step-card">
          <div class="step-number">4</div>
          <h3>결과 확인</h3>
          <p>대응 능력을 평가하고 개선 방안을 확인합니다</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Scenarios Info Section -->
  <section class="scenarios-info-section">
    <div class="container">
      <h2>시뮬레이션 시나리오</h2>
      <div class="scenarios-grid">
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-box"></i>
          </div>
          <h3>택배 배송 사칭</h3>
          <p>택배 미수령을 빌미로 개인정보와 금전을 요구하는 수법</p>
          <span class="difficulty-badge easy">난이도: 초급</span>
        </div>
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-university"></i>
          </div>
          <h3>금융감독원 사칭</h3>
          <p>금융 사고를 빌미로 안전계좌 이체를 유도하는 수법</p>
          <span class="difficulty-badge medium">난이도: 중급</span>
        </div>
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <h3>경찰청 사칭</h3>
          <p>범죄 연루를 빌미로 협박하며 금전을 요구하는 수법</p>
          <span class="difficulty-badge hard">난이도: 고급</span>
        </div>
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-users"></i>
          </div>
          <h3>가족 사칭</h3>
          <p>긴급 상황을 가장해 즉시 송금을 요구하는 수법</p>
          <span class="difficulty-badge medium">난이도: 중급</span>
        </div>
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-landmark"></i>
          </div>
          <h3>은행원 사칭</h3>
          <p>대출 승인이나 보안 문제로 정보를 요구하는 수법</p>
          <span class="difficulty-badge easy">난이도: 초급</span>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="cta-section">
    <div class="container">
      <div class="cta-content">
        <h2>지금 바로 시뮬레이션을 시작하세요</h2>
        <p>실전 연습을 통해 보이스피싱으로부터 자신을 보호하는 능력을 키워보세요</p>
        <button class="btn btn-primary" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">
          시뮬레이션 시작하기
        </button>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3 class="footer-logo">SumTech</h3>
          <p>보이스피싱 예방을 위한 AI 기반 솔루션을 제공합니다.</p>
        </div>
        <div class="footer-section">
          <h4>서비스</h4>
          <ul>
            <li><a href="service1.html">통화위험체크</a></li>
            <li><a href="service2.html">메세지 위협체크</a></li>
            <li><a href="service3.html">모의대화 코칭</a></li>
            <li><a href="service4.html">상황 퀴즈</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>긴급 신고</h4>
          <ul>
            <li>경찰신고: 112</li>
            <li>금융감독원: 1332</li>
            <li>보이스피싱: 1588-2112</li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>법적 고지</h4>
          <ul>
            <li><a href="#">이용약관</a></li>
            <li><a href="#">개인정보처리방침</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024 SumTech. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- 기능 스크립트: 변경하지 않았습니다 -->
  <script defer src="{{ url_for('static', path='voice-analysis.js') }}"></script>
</body>
<!-- 기능 스크립트: 기존 파일이 이미 로드하고 있던 외부 스크립트 유지 -->
<script defer src="{{ url_for('static', path='voice-analysis.js') }}"></script>

<!-- ✅ 기능 연결 스크립트: 엔드포인트 변경 없음 -->
<script>
(function(){
  const apiBase = "/api";
  let meta = {scenarios:{}, openers:{}, model:""};
  let sid = null;
  let scenario = null;

  // 이 페이지의 요소 ID에 맞춰 매핑
  const el = {
    scenario: document.getElementById('scenarioSelect'),
    opening: document.getElementById('openingPreview'),
    startBtn: document.getElementById('startSimulationBtn'),
    viewBtn: document.getElementById('viewResultBtn'),
    chatWrap: document.getElementById('chatMessages'),
    chatStatusIcon: document.getElementById('chatStatusIcon'),
    chatStatusText: document.getElementById('chatStatusText'),
    input: document.getElementById('chatInput'),
    sendBtn: document.getElementById('sendMessageBtn'),
  };

  // 채팅 말풍선 렌더
  function addBubble(role, text){
    const wrap = document.createElement('div');
    wrap.className = 'chat-message ' + (role==='user' ? 'user' : 'scammer');
    wrap.innerHTML = `
      <div class="message-avatar ${role==='user'?'user':'scammer'}">${role==='user'?'🙋':'🎭'}</div>
      <div class="message-content"><div class="message-bubble">${escapeHtml(text)}</div></div>`;
    el.chatWrap.appendChild(wrap);
    el.chatWrap.scrollTop = el.chatWrap.scrollHeight;
  }
  function escapeHtml(s){
    return (s||'').toString().replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  }
  function setStatus(txt, on){
    el.chatStatusText.textContent = txt;
    if (el.chatStatusIcon) el.chatStatusIcon.style.color = on ? '#10b981' : '#94a3b8';
  }

  function setScenarioUI(name){
    scenario = name;
    el.scenario.value = name;
    el.opening.textContent = meta.openers[name] || '전화드렸습니다. 본인 확인을 위해 잠시만요.';
  }

  async function loadMeta(){
    setStatus('메타 로딩…', false);
    try{
      const res = await fetch(apiBase + '/meta');
      if(!res.ok) throw new Error('meta 실패 ' + res.status);
      meta = await res.json();
      // 셀렉트 채우기(기존 하드코딩 옵션 덮어씀)
      el.scenario.innerHTML = '<option value="">시나리오 선택</option>' +
        Object.keys(meta.scenarios).map(k=>`<option value="${k}">${k}</option>`).join('');
      const first = Object.keys(meta.scenarios)[0];
      if(first) setScenarioUI(first);
      setStatus('대기 중…', false);
    }catch(e){
      setStatus('메타 로드 실패', false);
      console.error(e);
      addBubble('model','(오류) 메타 로드 실패');
    }
  }

  async function begin(){
    if(!scenario){ addBubble('model','시나리오를 먼저 선택하세요.'); return; }
    try{
      setStatus('연결 중…', true);
      addBubble('user','(전화 연결)');
      const res = await fetch(apiBase + '/begin',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({scenario})
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || 'begin 실패');
      sid = data.sid || Date.now();
      const text = data.text || '(응답 없음)';
      addBubble('model', text);
      el.input.disabled = false;
      el.sendBtn.disabled = false;
      el.input.focus();
      setStatus('연결됨', true);
    }catch(err){
      setStatus('연결 실패', false);
      console.error(err);
      addBubble('model','(오류) ' + err.message);
    }
  }

  async function send(){
    const message = (el.input.value||'').trim();
    if(!message) return;
    if(!sid){ addBubble('model','먼저 "전화 연결"을 눌러 시작하세요.'); return; }
    el.input.value='';
    addBubble('user', message);
    try{
      setStatus('응답 수신 중…', true);
      const res = await fetch(apiBase + '/chat',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({sid, scenario, message})
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || 'chat 실패');
      addBubble('model', data.text || '(응답 없음)');
      setStatus('연결됨', true);
    }catch(err){
      setStatus('오류', false);
      console.error(err);
      addBubble('model','(오류) ' + err.message);
    }
  }

  function mdToHtml(md){
    let h = (md||'')
      .replace(/^### (.*)$/gm,'<h3>$1</h3>')
      .replace(/^## (.*)$/gm,'<h2>$1</h2>')
      .replace(/^# (.*)$/gm,'<h1>$1</h1>')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/`([^`]+)`/g,'<code>$1</code>')
      .replace(/^- (.*)$/gm,'<li>$1</li>');
    h = h.replace(/(<li>[\s\S]*?<\/li>)/g,'<ul>$1</ul>');
    return h;
  }
  function openModal(html){
    let back = document.getElementById('mdBackdrop');
    if(!back){
      back = document.createElement('div');
      back.id = 'mdBackdrop';
      back.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1000';
      const modal = document.createElement('div');
      modal.style.cssText = 'width:min(880px,92vw);max-height:80vh;overflow:auto;background:#0f1730;border:1px solid #22304d;border-radius:14px;color:#e6edf3;padding:14px';
      modal.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 style="margin:0;font-size:16px">세션 요약 리포트</h3><button id="mdClose" class="btn primary">닫기</button></div><div id="mdBody" class="markdown small"></div>';
      back.appendChild(modal);
      document.body.appendChild(back);
      document.getElementById('mdClose').onclick = ()=> back.remove();
    }
    back.querySelector('#mdBody').innerHTML = html;
  }
  async function viewReport(){
    if(!sid){ addBubble('model','세션이 없습니다. 먼저 "전화 연결"을 눌러 시작하세요.'); return; }
    try{
      setStatus('리포트 생성…', true);
      const res = await fetch(apiBase + '/analyze_json',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({sid, scenario})
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || 'analyze_json 실패');
      openModal(mdToHtml(data.markdown || '(빈 리포트)'));
      setStatus('연결됨', true);
    }catch(err){
      setStatus('오류', false);
      console.error(err);
      addBubble('model','(오류) ' + err.message);
    }
  }

  // 이벤트 바인딩
  el.scenario.addEventListener('change', ()=> setScenarioUI(el.scenario.value));
  el.startBtn.addEventListener('click', begin);
  el.sendBtn.addEventListener('click', send);
  el.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
  el.viewBtn.addEventListener('click', viewReport);

  // 초기 로드
  loadMeta();
})();
</script>

</html>
