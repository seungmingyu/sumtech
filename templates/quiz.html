<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì˜ëŒ€í™” ì½”ì¹­ - SumTech</title>

  <!-- â¬‡ï¸ ì²«ë²ˆì§¸ ì½”ë“œì˜ ìŠ¤íƒ€ì¼ì„ ì´ì‹í–ˆìŠµë‹ˆë‹¤. ê¸°ëŠ¥/ì—”ë“œí¬ì¸íŠ¸ëŠ” ë³€ê²½í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. -->
  <style>
    :root{--bg:#0b1020;--fg:#e6edf3;--muted:#9aa4b2;--card:#121a31;--border:#22304d;--accent:#6aa0ff;--warn:#f5a524}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic}
    header{padding:14px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(11,16,32,.9);backdrop-filter:saturate(1.2) blur(6px)}
    h1{margin:0;font-size:18px}
    .wrap{max-width:960px;margin:16px auto;padding:0 12px 28px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px}
    .pad{padding:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    select,input{width:100%;background:#0f1730;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none}
    .btn{background:#162446;border:1px solid var(--border);color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:#5b8fee;color:#0b1020;font-weight:600}
    .btn.warn{background:var(--warn);border-color:#e89519;color:#0b1020;font-weight:600}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .chat{display:flex;flex-direction:column;gap:10px;height:60vh;padding:14px;overflow:auto}
    .msg{max-width:85%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);white-space:pre-wrap;line-height:1.45}
    .msg.user{margin-left:auto;background:#13223f}
    .msg.bot{margin-right:auto;background:#111b34}
    .msg.sys{margin:6px auto 0 auto;background:#0f1730;border-style:dashed;color:var(--muted);font-size:12px}
    .small{font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .row-end{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .sep{height:1px;background:var(--border);margin:10px 0}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(880px,92vw);max-height:80vh;overflow:auto;background:#0f1730;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .modal .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .modal .bd{padding:14px}
    .modal .hd h3{margin:0;font-size:16px}
    .markdown h1,.markdown h2,.markdown h3{margin:.6em 0 .3em}
    .markdown p,.markdown li{line-height:1.55}
    .markdown code{background:#111b34;padding:.1em .35em;border-radius:6px}
    .markdown pre{background:#111b34;padding:10px;border-radius:10px;overflow:auto}
    .markdown ul{padding-left:20px}
  </style>

  <!-- ê¸°ì¡´ ì™¸ë¶€ ìŠ¤íƒ€ì¼ì€ ìœ ì§€ (ê¸°ëŠ¥ ì˜í–¥ ì—†ìŒ) -->
  <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <a href="index.html" style="text-decoration: none;">
          <span class="logo-text">SumTech</span>
        </a>
      </div>
      <ul class="nav-menu">
        <li><a href="/" class="nav-link">í™ˆ</a></li>
        <li><a href="/scan/voice" class="nav-link">í†µí™”ìœ„í—˜ì²´í¬</a></li>
        <li><a href="/scan/message" class="nav-link">ë©”ì„¸ì§€ ìœ„í˜‘ì²´í¬</a></li>
        <li><a href="/api/chat-bot" class="nav-link active">ëª¨ì˜ëŒ€í™” ì½”ì¹­</a></li>
        <li><a href="service4.html" class="nav-link">ìƒí™© í€´ì¦ˆ</a></li>
      </ul>
    </div>
  </nav>

  <!-- Service Detail Hero -->
  <section class="service-detail-hero">
    <div class="container">
      <h1>ëª¨ì˜ëŒ€í™” ì½”ì¹­</h1>
      <p class="hero-subtitle">ì‹¤ì œ ë³´ì´ìŠ¤í”¼ì‹± ì‹œë‚˜ë¦¬ì˜¤ë¡œ ëŒ€í™”í•˜ë©° ì˜¬ë°”ë¥¸ ëŒ€ì‘ë²•ì„ ë°°ì›ë‹ˆë‹¤</p>
    </div>
  </section>

  <!-- Chat Simulation Section -->
  <section class="chat-simulation-section">
    <div class="container">
      <div class="simulation-wrapper">
        <!-- Left Panel - Settings -->
        <div class="simulation-sidebar">
          <div class="sidebar-section">
            <label class="sidebar-label">ì‹œë‚˜ë¦¬ì˜¤</label>
            <div class="custom-select-wrapper">
              <select id="scenarioSelect" class="custom-select">
                <option value="">ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</option>
                <option value="scenario1">íƒë°° ë°°ì†¡ ì‚¬ì¹­</option>
                <option value="scenario2">ê¸ˆìœµê°ë…ì› ì‚¬ì¹­</option>
                <option value="scenario3">ê²½ì°°ì²­ ì‚¬ì¹­</option>
                <option value="scenario4">ê°€ì¡± ì‚¬ì¹­</option>
                <option value="scenario5">ì€í–‰ì› ì‚¬ì¹­</option>
              </select>
              <i class="fas fa-chevron-down select-arrow"></i>
            </div>
          </div>

          <div class="sidebar-section">
            <label class="sidebar-label">ì˜¤í”„ë‹(ì²« ì„  ë©˜íŠ¸)</label>
            <div class="opening-preview" id="openingPreview">
              ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ë©´ ì˜¤í”„ë‹ ë©˜íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
          </div>

          <button class="btn btn-accent btn-full" id="startSimulationBtn">
            <i class="fas fa-phone-alt"></i>
            ì „í™” ì—°ê²°(ì²« ì„  ë©˜íŠ¸)
          </button>

          <button class="btn btn-outline btn-full" id="viewResultBtn" style="margin-top: 1rem;">
            <i class="fas fa-chart-bar"></i>
            ê²°ê³¼ ë³´ëŸ¬ê°€ê¸°
          </button>

          <div class="sidebar-info">
            <h4><i class="fas fa-info-circle"></i> ê°œì¸ì •ë³´ ì…ë ¥ ê¸ˆì§€</h4>
            <p>ì‹¤ì œ ê°œì¸ì •ë³´ëŠ” ì ˆëŒ€ ì…ë ¥í•˜ì§€ ë§ˆì„¸ìš”.</p>
            <p class="info-detail">ì‹œë®¬ë ˆì´ì…˜ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
          </div>
        </div>

        <!-- Right Panel - Chat Interface -->
        <div class="simulation-chat">
          <div class="chat-header">
            <div class="chat-status">
              <i class="fas fa-circle" id="chatStatusIcon"></i>
              <span id="chatStatusText">ëŒ€ê¸° ì¤‘...</span>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div class="chat-welcome">
              <i class="fas fa-shield-alt"></i>
              <h3>ë³´ì´ìŠ¤í”¼ì‹± ì‹œë®¬ë ˆì´ì…˜ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h3>
              <p>ì™¼ìª½ì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ê³  'ì „í™” ì—°ê²°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>
              <div class="welcome-tips">
                <div class="tip-item">
                  <i class="fas fa-check-circle"></i>
                  <span>ì‹¤ì œ ë³´ì´ìŠ¤í”¼ì‹± ëŒ€í™”ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤</span>
                </div>
                <div class="tip-item">
                  <i class="fas fa-check-circle"></i>
                  <span>ì–´ë–»ê²Œ ëŒ€ì‘í•˜ëŠ”ì§€ í‰ê°€í•˜ê³  í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤</span>
                </div>
                <div class="tip-item">
                  <i class="fas fa-check-circle"></i>
                  <span>ì‹¤ì œ ê°œì¸ì •ë³´ëŠ” ì ˆëŒ€ ì…ë ¥í•˜ì§€ ë§ˆì„¸ìš”</span>
                </div>
              </div>
            </div>
          </div>

          <div class="chat-input-wrapper">
            <textarea 
              id="chatInput" 
              placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter ì „ì†¡)"
              rows="1"
              disabled
            ></textarea>
            <button class="btn btn-primary chat-send-btn" id="sendMessageBtn" disabled>
              ì „ì†¡
            </button>
          </div>

          <div class="chat-footer">
            <span>ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ</span>
            <span class="divider">|</span>
            <span>ë¡œì»¬ ì‹¤í–‰</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- How It Works Section -->
  <section class="how-it-works-section">
    <div class="container">
      <h2>ì‹œë®¬ë ˆì´ì…˜ ì§„í–‰ ë°©ë²•</h2>
      <div class="steps-grid">
        <div class="step-card">
          <div class="step-number">1</div>
          <h3>ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</h3>
          <p>ë‹¤ì–‘í•œ ë³´ì´ìŠ¤í”¼ì‹± ìœ í˜• ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤</p>
        </div>
        <div class="step-card">
          <div class="step-number">2</div>
          <h3>ëŒ€í™” ì‹œì‘</h3>
          <p>AIê°€ ì‹¤ì œ ë³´ì´ìŠ¤í”¼ì‹±ë²”ì²˜ëŸ¼ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤</p>
        </div>
        <div class="step-card">
          <div class="step-number">3</div>
          <h3>ëŒ€ì‘ ì—°ìŠµ</h3>
          <p>ì§ì ‘ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©° ëŒ€ì‘ ë°©ë²•ì„ ì—°ìŠµí•©ë‹ˆë‹¤</p>
        </div>
        <div class="step-card">
          <div class="step-number">4</div>
          <h3>ê²°ê³¼ í™•ì¸</h3>
          <p>ëŒ€ì‘ ëŠ¥ë ¥ì„ í‰ê°€í•˜ê³  ê°œì„  ë°©ì•ˆì„ í™•ì¸í•©ë‹ˆë‹¤</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Scenarios Info Section -->
  <section class="scenarios-info-section">
    <div class="container">
      <h2>ì‹œë®¬ë ˆì´ì…˜ ì‹œë‚˜ë¦¬ì˜¤</h2>
      <div class="scenarios-grid">
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-box"></i>
          </div>
          <h3>íƒë°° ë°°ì†¡ ì‚¬ì¹­</h3>
          <p>íƒë°° ë¯¸ìˆ˜ë ¹ì„ ë¹Œë¯¸ë¡œ ê°œì¸ì •ë³´ì™€ ê¸ˆì „ì„ ìš”êµ¬í•˜ëŠ” ìˆ˜ë²•</p>
          <span class="difficulty-badge easy">ë‚œì´ë„: ì´ˆê¸‰</span>
        </div>
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-university"></i>
          </div>
          <h3>ê¸ˆìœµê°ë…ì› ì‚¬ì¹­</h3>
          <p>ê¸ˆìœµ ì‚¬ê³ ë¥¼ ë¹Œë¯¸ë¡œ ì•ˆì „ê³„ì¢Œ ì´ì²´ë¥¼ ìœ ë„í•˜ëŠ” ìˆ˜ë²•</p>
          <span class="difficulty-badge medium">ë‚œì´ë„: ì¤‘ê¸‰</span>
        </div>
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <h3>ê²½ì°°ì²­ ì‚¬ì¹­</h3>
          <p>ë²”ì£„ ì—°ë£¨ë¥¼ ë¹Œë¯¸ë¡œ í˜‘ë°•í•˜ë©° ê¸ˆì „ì„ ìš”êµ¬í•˜ëŠ” ìˆ˜ë²•</p>
          <span class="difficulty-badge hard">ë‚œì´ë„: ê³ ê¸‰</span>
        </div>
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-users"></i>
          </div>
          <h3>ê°€ì¡± ì‚¬ì¹­</h3>
          <p>ê¸´ê¸‰ ìƒí™©ì„ ê°€ì¥í•´ ì¦‰ì‹œ ì†¡ê¸ˆì„ ìš”êµ¬í•˜ëŠ” ìˆ˜ë²•</p>
          <span class="difficulty-badge medium">ë‚œì´ë„: ì¤‘ê¸‰</span>
        </div>
        <div class="scenario-card">
          <div class="scenario-icon">
            <i class="fas fa-landmark"></i>
          </div>
          <h3>ì€í–‰ì› ì‚¬ì¹­</h3>
          <p>ëŒ€ì¶œ ìŠ¹ì¸ì´ë‚˜ ë³´ì•ˆ ë¬¸ì œë¡œ ì •ë³´ë¥¼ ìš”êµ¬í•˜ëŠ” ìˆ˜ë²•</p>
          <span class="difficulty-badge easy">ë‚œì´ë„: ì´ˆê¸‰</span>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="cta-section">
    <div class="container">
      <div class="cta-content">
        <h2>ì§€ê¸ˆ ë°”ë¡œ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•˜ì„¸ìš”</h2>
        <p>ì‹¤ì „ ì—°ìŠµì„ í†µí•´ ë³´ì´ìŠ¤í”¼ì‹±ìœ¼ë¡œë¶€í„° ìì‹ ì„ ë³´í˜¸í•˜ëŠ” ëŠ¥ë ¥ì„ í‚¤ì›Œë³´ì„¸ìš”</p>
        <button class="btn btn-primary" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">
          ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘í•˜ê¸°
        </button>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3 class="footer-logo">SumTech</h3>
          <p>ë³´ì´ìŠ¤í”¼ì‹± ì˜ˆë°©ì„ ìœ„í•œ AI ê¸°ë°˜ ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
        </div>
        <div class="footer-section">
          <h4>ì„œë¹„ìŠ¤</h4>
          <ul>
            <li><a href="service1.html">í†µí™”ìœ„í—˜ì²´í¬</a></li>
            <li><a href="service2.html">ë©”ì„¸ì§€ ìœ„í˜‘ì²´í¬</a></li>
            <li><a href="service3.html">ëª¨ì˜ëŒ€í™” ì½”ì¹­</a></li>
            <li><a href="service4.html">ìƒí™© í€´ì¦ˆ</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>ê¸´ê¸‰ ì‹ ê³ </h4>
          <ul>
            <li>ê²½ì°°ì‹ ê³ : 112</li>
            <li>ê¸ˆìœµê°ë…ì›: 1332</li>
            <li>ë³´ì´ìŠ¤í”¼ì‹±: 1588-2112</li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>ë²•ì  ê³ ì§€</h4>
          <ul>
            <li><a href="#">ì´ìš©ì•½ê´€</a></li>
            <li><a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024 SumTech. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸: ë³€ê²½í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ -->
  <script defer src="{{ url_for('static', path='voice-analysis.js') }}"></script>
</body>
<!-- ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸: ê¸°ì¡´ íŒŒì¼ì´ ì´ë¯¸ ë¡œë“œí•˜ê³  ìˆë˜ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€ -->
<script defer src="{{ url_for('static', path='voice-analysis.js') }}"></script>

<!-- âœ… ê¸°ëŠ¥ ì—°ê²° ìŠ¤í¬ë¦½íŠ¸: ì—”ë“œí¬ì¸íŠ¸ ë³€ê²½ ì—†ìŒ -->
<script>
(function(){
  const apiBase = "/api";
  let meta = {scenarios:{}, openers:{}, model:""};
  let sid = null;
  let scenario = null;

  // ì´ í˜ì´ì§€ì˜ ìš”ì†Œ IDì— ë§ì¶° ë§¤í•‘
  const el = {
    scenario: document.getElementById('scenarioSelect'),
    opening: document.getElementById('openingPreview'),
    startBtn: document.getElementById('startSimulationBtn'),
    viewBtn: document.getElementById('viewResultBtn'),
    chatWrap: document.getElementById('chatMessages'),
    chatStatusIcon: document.getElementById('chatStatusIcon'),
    chatStatusText: document.getElementById('chatStatusText'),
    input: document.getElementById('chatInput'),
    sendBtn: document.getElementById('sendMessageBtn'),
  };

  // ì±„íŒ… ë§í’ì„  ë Œë”
  function addBubble(role, text){
    const wrap = document.createElement('div');
    wrap.className = 'chat-message ' + (role==='user' ? 'user' : 'scammer');
    wrap.innerHTML = `
      <div class="message-avatar ${role==='user'?'user':'scammer'}">${role==='user'?'ğŸ™‹':'ğŸ­'}</div>
      <div class="message-content"><div class="message-bubble">${escapeHtml(text)}</div></div>`;
    el.chatWrap.appendChild(wrap);
    el.chatWrap.scrollTop = el.chatWrap.scrollHeight;
  }
  function escapeHtml(s){
    return (s||'').toString().replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  }
  function setStatus(txt, on){
    el.chatStatusText.textContent = txt;
    if (el.chatStatusIcon) el.chatStatusIcon.style.color = on ? '#10b981' : '#94a3b8';
  }

  function setScenarioUI(name){
    scenario = name;
    el.scenario.value = name;
    el.opening.textContent = meta.openers[name] || 'ì „í™”ë“œë ¸ìŠµë‹ˆë‹¤. ë³¸ì¸ í™•ì¸ì„ ìœ„í•´ ì ì‹œë§Œìš”.';
  }

  async function loadMeta(){
    setStatus('ë©”íƒ€ ë¡œë”©â€¦', false);
    try{
      const res = await fetch(apiBase + '/meta');
      if(!res.ok) throw new Error('meta ì‹¤íŒ¨ ' + res.status);
      meta = await res.json();
      // ì…€ë ‰íŠ¸ ì±„ìš°ê¸°(ê¸°ì¡´ í•˜ë“œì½”ë”© ì˜µì…˜ ë®ì–´ì”€)
      el.scenario.innerHTML = '<option value="">ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</option>' +
        Object.keys(meta.scenarios).map(k=>`<option value="${k}">${k}</option>`).join('');
      const first = Object.keys(meta.scenarios)[0];
      if(first) setScenarioUI(first);
      setStatus('ëŒ€ê¸° ì¤‘â€¦', false);
    }catch(e){
      setStatus('ë©”íƒ€ ë¡œë“œ ì‹¤íŒ¨', false);
      console.error(e);
      addBubble('model','(ì˜¤ë¥˜) ë©”íƒ€ ë¡œë“œ ì‹¤íŒ¨');
    }
  }

  async function begin(){
    if(!scenario){ addBubble('model','ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
    try{
      setStatus('ì—°ê²° ì¤‘â€¦', true);
      addBubble('user','(ì „í™” ì—°ê²°)');
      const res = await fetch(apiBase + '/begin',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({scenario})
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || 'begin ì‹¤íŒ¨');
      sid = data.sid || Date.now();
      const text = data.text || '(ì‘ë‹µ ì—†ìŒ)';
      addBubble('model', text);
      el.input.disabled = false;
      el.sendBtn.disabled = false;
      el.input.focus();
      setStatus('ì—°ê²°ë¨', true);
    }catch(err){
      setStatus('ì—°ê²° ì‹¤íŒ¨', false);
      console.error(err);
      addBubble('model','(ì˜¤ë¥˜) ' + err.message);
    }
  }

  async function send(){
    const message = (el.input.value||'').trim();
    if(!message) return;
    if(!sid){ addBubble('model','ë¨¼ì € "ì „í™” ì—°ê²°"ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.'); return; }
    el.input.value='';
    addBubble('user', message);
    try{
      setStatus('ì‘ë‹µ ìˆ˜ì‹  ì¤‘â€¦', true);
      const res = await fetch(apiBase + '/chat',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({sid, scenario, message})
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || 'chat ì‹¤íŒ¨');
      addBubble('model', data.text || '(ì‘ë‹µ ì—†ìŒ)');
      setStatus('ì—°ê²°ë¨', true);
    }catch(err){
      setStatus('ì˜¤ë¥˜', false);
      console.error(err);
      addBubble('model','(ì˜¤ë¥˜) ' + err.message);
    }
  }

  function mdToHtml(md){
    let h = (md||'')
      .replace(/^### (.*)$/gm,'<h3>$1</h3>')
      .replace(/^## (.*)$/gm,'<h2>$1</h2>')
      .replace(/^# (.*)$/gm,'<h1>$1</h1>')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/`([^`]+)`/g,'<code>$1</code>')
      .replace(/^- (.*)$/gm,'<li>$1</li>');
    h = h.replace(/(<li>[\s\S]*?<\/li>)/g,'<ul>$1</ul>');
    return h;
  }
  function openModal(html){
    let back = document.getElementById('mdBackdrop');
    if(!back){
      back = document.createElement('div');
      back.id = 'mdBackdrop';
      back.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1000';
      const modal = document.createElement('div');
      modal.style.cssText = 'width:min(880px,92vw);max-height:80vh;overflow:auto;background:#0f1730;border:1px solid #22304d;border-radius:14px;color:#e6edf3;padding:14px';
      modal.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 style="margin:0;font-size:16px">ì„¸ì…˜ ìš”ì•½ ë¦¬í¬íŠ¸</h3><button id="mdClose" class="btn primary">ë‹«ê¸°</button></div><div id="mdBody" class="markdown small"></div>';
      back.appendChild(modal);
      document.body.appendChild(back);
      document.getElementById('mdClose').onclick = ()=> back.remove();
    }
    back.querySelector('#mdBody').innerHTML = html;
  }
  async function viewReport(){
    if(!sid){ addBubble('model','ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € "ì „í™” ì—°ê²°"ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.'); return; }
    try{
      setStatus('ë¦¬í¬íŠ¸ ìƒì„±â€¦', true);
      const res = await fetch(apiBase + '/analyze_json',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({sid, scenario})
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || 'analyze_json ì‹¤íŒ¨');
      openModal(mdToHtml(data.markdown || '(ë¹ˆ ë¦¬í¬íŠ¸)'));
      setStatus('ì—°ê²°ë¨', true);
    }catch(err){
      setStatus('ì˜¤ë¥˜', false);
      console.error(err);
      addBubble('model','(ì˜¤ë¥˜) ' + err.message);
    }
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  el.scenario.addEventListener('change', ()=> setScenarioUI(el.scenario.value));
  el.startBtn.addEventListener('click', begin);
  el.sendBtn.addEventListener('click', send);
  el.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
  el.viewBtn.addEventListener('click', viewReport);

  // ì´ˆê¸° ë¡œë“œ
  loadMeta();
})();
</script>

</html>
