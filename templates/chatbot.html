<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>모의대화 코칭 - SumTech</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* 기존 로직 유지를 위한 추가 스타일 */
    .msg{max-width:85%;padding:10px 12px;border-radius:12px;white-space:pre-wrap;line-height:1.45;animation:fadeIn 0.3s;}
    .msg.user{margin-left:auto;background:var(--accent-teal);color:var(--white);border-bottom-right-radius:4px;}
    .msg.bot{margin-right:auto;background:#334155;color:var(--white);border-bottom-left-radius:4px;}
    .msg.sys{margin:6px auto 0 auto;background:#0f172a;border:1px dashed #334155;color:#94a3b8;font-size:12px;text-align:center;max-width:100%;}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:9999;}
    .modal{width:min(880px,92vw);max-height:80vh;overflow:auto;background:#0f172a;border:1px solid #334155;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.6);}
    .modal .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #334155;}
    .modal .bd{padding:20px;}
    .modal .hd h3{margin:0;font-size:18px;color:var(--white);font-weight:600;}
    .markdown{color:#cbd5e1;}
    .markdown h1,.markdown h2,.markdown h3{margin:.8em 0 .4em;color:var(--white);}
    .markdown p,.markdown li{line-height:1.6;margin-bottom:0.8em;}
    .markdown code{background:#1e293b;padding:.2em .4em;border-radius:6px;color:#60a5fa;}
    .markdown pre{background:#1e293b;padding:12px;border-radius:10px;overflow:auto;}
    .markdown ul{padding-left:24px;margin:0.6em 0;}
    .markdown strong{color:var(--white);font-weight:600;}
  </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-logo">
            <a href="index.html" style="text-decoration: none;">
                <span class="logo-text">SumTech</span>
            </a>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html" class="nav-link">홈</a></li>
            <li><a href="service1.html" class="nav-link">통화위험체크</a></li>
            <li><a href="service2.html" class="nav-link">메세지 위협체크</a></li>
            <li><a href="service3.html" class="nav-link active">모의대화 코칭</a></li>
            <li><a href="service4.html" class="nav-link">상황 퀴즈</a></li>
        </ul>
    </div>
</nav>

<!-- Service Detail Hero -->
<section class="service-detail-hero">
    <div class="container">
        <h1>모의대화 코칭</h1>
        <p class="hero-subtitle">실제 보이스피싱 시나리오로 대화하며 올바른 대응법을 배웁니다</p>
    </div>
</section>

<!-- Chat Simulation Section -->
<section class="chat-simulation-section">
    <div class="container">
        <div class="simulation-wrapper">
            <!-- Left Panel - Settings -->
            <div class="simulation-sidebar">
                <div class="sidebar-section">
                    <label class="sidebar-label">시나리오</label>
                    <div class="custom-select-wrapper">
                        <select id="scenario" class="custom-select"></select>
                        <i class="fas fa-chevron-down select-arrow"></i>
                    </div>
                    <div id="scenarioDesc" style="font-size:13px;color:#94a3b8;margin-top:8px;line-height:1.5;"></div>
                </div>

                <div class="sidebar-section">
                    <label class="sidebar-label">오프닝(첫 선 멘트)</label>
                    <div class="opening-preview" id="opener">
                        시나리오를 선택하면 오프닝 멘트가 표시됩니다.
                    </div>
                </div>

                <button class="btn btn-accent btn-full" id="btnBegin">
                    <i class="fas fa-phone-alt"></i>
                    전화 연결(봇 선 멘트)
                </button>

                <button class="btn btn-outline btn-full" id="btnReport" style="margin-top: 1rem;">
                    <i class="fas fa-chart-bar"></i>
                    결과 보러가기
                </button>

                <div class="sidebar-info">
                    <h4><i class="fas fa-info-circle"></i> 백엔드 API 연동</h4>
                    <p style="font-size:11px;color:#94a3b8;margin-top:4px;">
                        <code style="background:#1e293b;padding:2px 6px;border-radius:4px;font-size:10px;">/api/meta</code>, 
                        <code style="background:#1e293b;padding:2px 6px;border-radius:4px;font-size:10px;">/api/begin</code>, 
                        <code style="background:#1e293b;padding:2px 6px;border-radius:4px;font-size:10px;">/api/chat</code>, 
                        <code style="background:#1e293b;padding:2px 6px;border-radius:4px;font-size:10px;">/api/analyze_json</code>
                    </p>
                    <p class="info-detail" style="margin-top:8px;color:#f59e0b;"><i class="fas fa-exclamation-triangle"></i> 개인정보 입력 금지 (서버 자동 마스킹)</p>
                </div>
            </div>

            <!-- Right Panel - Chat Interface -->
            <div class="simulation-chat">
                <div class="chat-header">
                    <div class="chat-status">
                        <i class="fas fa-circle" style="color:#10b981;"></i>
                        <span>세션: <code id="sid" style="background:#1e293b;padding:2px 8px;border-radius:4px;font-size:11px;">—</code></span>
                        <span style="margin-left:12px;">모델: <code id="model" style="background:#1e293b;padding:2px 8px;border-radius:4px;font-size:11px;">—</code></span>
                    </div>
                </div>

                <div class="chat-messages" id="chat"></div>

                <div class="chat-input-wrapper">
                    <input 
                        id="msg" 
                        type="text"
                        placeholder="메시지를 입력하세요 (Enter 전송)"
                        style="flex:1;background:#1e293b;border:1px solid #334155;border-radius:12px;padding:12px 16px;color:var(--white);outline:none;"
                    />
                    <button class="btn btn-primary chat-send-btn" id="btnSend" disabled>
                        전송
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h3 class="footer-logo">SumTech</h3>
                <p>보이스피싱 예방을 위한 AI 기반 솔루션을 제공합니다.</p>
            </div>
            <div class="footer-section">
                <h4>서비스</h4>
                <ul>
                    <li><a href="service1.html">통화위험체크</a></li>
                    <li><a href="service2.html">메세지 위협체크</a></li>
                    <li><a href="service3.html">모의대화 코칭</a></li>
                    <li><a href="service4.html">상황 퀴즈</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>긴급 신고</h4>
                <ul>
                    <li>경찰신고: 112</li>
                    <li>금융감독원: 1332</li>
                    <li>보이스피싱: 1588-2112</li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>법적 고지</h4>
                <ul>
                    <li><a href="#">이용약관</a></li>
                    <li><a href="#">개인정보처리방침</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 SumTech. All rights reserved.</p>
        </div>
    </div>
</footer>

<!-- Modal -->
<div id="mdModal" class="modal-backdrop">
  <div class="modal">
    <div class="hd">
      <h3>세션 요약 리포트</h3>
      <div style="display:flex; gap:8px">
        <button id="btnDl" class="btn btn-primary">다운로드(.md)</button>
        <button id="btnClose" class="btn btn-outline">닫기</button>
      </div>
    </div>
    <div class="bd">
      <div id="mdBody" class="markdown">(로딩 중…)</div>
    </div>
  </div>
</div>

<script>
const apiBase = "/api";

let meta = {scenarios:{}, openers:{}, model:""};
let sid = null;
let scenario = null;
let history = [];

const el = {
  scenario: document.getElementById('scenario'),
  scenarioDesc: document.getElementById('scenarioDesc'),
  opener: document.getElementById('opener'),
  chat: document.getElementById('chat'),
  msg: document.getElementById('msg'),
  btnSend: document.getElementById('btnSend'),
  btnBegin: document.getElementById('btnBegin'),
  btnReport: document.getElementById('btnReport'),
  sid: document.getElementById('sid'),
  model: document.getElementById('model'),
};

function addMsg(role,text){
  const div=document.createElement('div');
  div.className='msg '+(role==='user'?'user':role==='model'?'bot':'sys');
  div.textContent=text;
  el.chat.appendChild(div);
  el.chat.scrollTop=el.chat.scrollHeight;
}
function setScenarioUI(name){
  scenario=name;
  el.scenario.value=name;
  el.scenarioDesc.textContent=meta.scenarios[name]||"";
  el.opener.textContent=meta.openers[name]||"전화드렸습니다. 본인 확인을 위해 잠시만요.";
}
async function loadMeta(){
  addMsg('sys','/api/meta 로딩 중…');
  const res=await fetch(apiBase+"/meta");
  if(!res.ok)throw new Error("meta 실패 "+res.status);
  meta=await res.json();
  el.scenario.innerHTML="";
  Object.keys(meta.scenarios).forEach(k=>{
    const opt=document.createElement('option');
    opt.value=k; opt.textContent=k; el.scenario.appendChild(opt);
  });
  setScenarioUI(Object.keys(meta.scenarios)[0]);
  el.model.textContent=meta.model||'—';
  addMsg('sys','준비 완료. 시나리오를 선택하고 "전화 연결"을 누르세요.');
}
el.scenario.addEventListener('change',()=>setScenarioUI(el.scenario.value));

el.btnBegin.addEventListener('click',async()=>{
  try{
    if(!scenario){addMsg('sys','시나리오를 먼저 선택하세요.');return;}
    addMsg('user','(전화 연결)');
    const res=await fetch(apiBase+"/begin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({scenario})});
    const data=await res.json();
    if(!res.ok)throw new Error(data.detail||'begin 실패');
    sid=data.sid||Date.now();
    el.sid.textContent=sid;
    const text=data.text||"(응답 없음)";
    addMsg('model',text);
    el.btnSend.disabled=false;
    el.msg.focus();
  }catch(err){addMsg('sys','(오류) '+err);}
});

async function sendMessage(){
  const message=el.msg.value.trim();
  if(!message)return;
  if(!sid){addMsg('sys','먼저 "전화 연결"을 눌러 세션을 시작하세요.');return;}
  el.msg.value="";
  addMsg('user',message);
  try{
    const res=await fetch(apiBase+"/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sid,scenario,message})});
    const data=await res.json();
    if(!res.ok)throw new Error(data.detail||'chat 실패');
    const text=data.text||"(응답 없음)";
    addMsg('model',text);
  }catch(err){addMsg('sys','(오류) '+err);}
}
el.btnSend.addEventListener('click',sendMessage);
el.msg.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
});

/* ----- Modal ----- */
function mdToHtml(md){
  let h=md.replace(/^### (.*)$/gm,'<h3>$1</h3>')
          .replace(/^## (.*)$/gm,'<h2>$1</h2>')
          .replace(/^# (.*)$/gm,'<h1>$1</h1>')
          .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
          .replace(/`([^`]+)`/g,'<code>$1</code>')
          .replace(/^- (.*)$/gm,'<li>$1</li>');
  h=h.replace(/(<li>[\s\S]*?<\/li>)/g,'<ul>$1</ul>');
  return h;
}
const modal={root:document.getElementById('mdModal'),body:document.getElementById('mdBody'),
btnClose:document.getElementById('btnClose'),btnDl:document.getElementById('btnDl'),
open(html){this.body.innerHTML=html;this.root.style.display='flex';},
close(){this.root.style.display='none';}};
modal.btnClose.addEventListener('click',()=>modal.close());

el.btnReport.addEventListener('click',async()=>{
  try{
    if(!sid){addMsg('sys','세션이 없습니다. 먼저 "전화 연결"을 눌러 시작하세요.');return;}
    addMsg('sys','요약 리포트 생성 중…');
    const res=await fetch(apiBase+"/analyze_json",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sid,scenario})});
    const data=await res.json();
    if(!res.ok)throw new Error(data.detail||'analyze_json 실패');
    modal.open(mdToHtml(data.markdown||'(빈 리포트)'));
    modal.btnDl.onclick=async()=>{
      const resp=await fetch(apiBase+"/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sid,scenario})});
      const blob=await resp.blob();
      const a=document.createElement('a');
      const url=URL.createObjectURL(blob);
      a.href=url;a.download=`report_session_${sid}.md`;
      document.body.appendChild(a);a.click();
      URL.revokeObjectURL(url);a.remove();
    };
  }catch(err){addMsg('sys','(오류) '+err);}
});

loadMeta().catch(err=>addMsg('sys','(오류) 메타 로드 실패: '+err));
</script>
</body>
</html>