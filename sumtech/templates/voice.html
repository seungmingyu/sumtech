<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>보이스피싱 검사 결과 - 피싱탐지</title>
  <style>
    body{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#F7F9FB;color:#1F2A37;min-height:100vh}
    html{height:100%}*{box-sizing:border-box}
    .navbar{background:#fff;border-bottom:1px solid #E5E7EB;position:fixed;top:0;left:0;right:0;height:70px;display:flex;align-items:center;justify-content:space-between;padding:0 40px;z-index:100}
    .logo-text{font-size:20px;font-weight:600;color:#0B57A4}
    .nav-menu{display:flex;align-items:center;gap:32px}
    .nav-item{display:flex;align-items:center;padding:8px 16px;color:#6B7280;text-decoration:none;transition:.2s;border-radius:6px;font-size:14px;font-weight:500}
    .nav-item:hover{background:#F3F4F6;color:#1F2A37}
    .nav-item.active{background:#EBF5FF;color:#0B57A4}
    main{margin-top:90px;padding:40px 20px;max-width:1200px;margin-left:auto;margin-right:auto}
    h1{font-size:28px;font-weight:700;margin-bottom:10px}
    .description{color:#6B7280;font-size:15px;margin-bottom:40px}
    .upload-section{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:40px;margin-bottom:30px}
    .upload-section h2{font-size:18px;font-weight:700;color:#1F2A37;margin-bottom:20px}
    .upload-area{border:2px dashed #D1D5DB;border-radius:12px;padding:60px 20px;background:#FAFBFC;text-align:center;color:#6B7280;font-size:15px;cursor:pointer;transition:.3s;margin-bottom:20px}
    .upload-area:hover{border-color:#0B57A4;background:#F9FAFB}
    .upload-area.uploading{border-color:#0B57A4;background:#EBF5FF}
    .upload-area input{display:none}
    .buttons{display:flex;gap:10px}
    .btn{background:#0B57A4;color:#fff;padding:10px 24px;border-radius:8px;border:none;cursor:pointer;font-size:14px;font-weight:600;transition:.2s}
    .btn:hover:not(:disabled){background:#094A8F}
    .btn:disabled{background:#D1D5DB;cursor:not-allowed;opacity:.6}
    .btn-secondary{background:#E5E7EB;color:#1F2A37}
    .btn-secondary:hover{background:#D1D5DB}
    .progress-bar{height:8px;width:100%;background:#E5E7EB;border-radius:6px;margin-top:20px;overflow:hidden;display:none}
    .progress-bar.active{display:block}
    .progress{height:100%;width:0;background:#0B57A4;transition:width .2s ease}
    .result-container{display:none;animation:fadeIn .5s}
    .result-container.show{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .risk-card,.detail-card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:32px;margin-bottom:20px}
    .risk-card{text-align:center;padding:40px}
    .risk-indicator{width:160px;height:160px;margin:0 auto 24px;position:relative}
    .risk-circle{width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:48px;font-weight:700;border:8px solid;animation:pulse 2s ease-in-out infinite}
    .risk-circle.high{border-color:#EF4444;background:#FEF2F2;color:#DC2626}
    .risk-circle.medium{border-color:#F59E0B;background:#FFFBEB;color:#D97706}
    .risk-circle.low{border-color:#10B981;background:#F0FDF4;color:#059669}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .risk-label{font-size:12px;font-weight:600;text-transform:uppercase;margin-top:8px;letter-spacing:.5px}
    .risk-title{font-size:24px;font-weight:700;margin-bottom:8px}
    .risk-subtitle{color:#6B7280;font-size:14px}
    .detail-card h3{font-size:18px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .detail-card p{color:#374151;font-size:15px;line-height:1.7;margin:0}
    .icon-badge{width:32px;height:32px;background:#EBF5FF;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
    .action-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:30px}
    .action-btn{background:#fff;border:2px solid #E5E7EB;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:.2s;text-decoration:none;color:#1F2A37}
    .action-btn:hover{border-color:#0B57A4;background:#F9FAFB;transform:translateY(-2px)}
    .action-btn-icon{font-size:32px;margin-bottom:8px}
    .action-btn-title{font-size:14px;font-weight:600;margin-bottom:4px}
    .action-btn-desc{font-size:12px;color:#6B7280}
    .reference-tag{display:inline-block;background:#F3F4F6;color:#6B7280;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;margin:4px 4px 4px 0}
    .footer{background:#1F2A37;color:#fff;padding:40px;text-align:center;margin-top:60px}
    .footer-links{display:flex;justify-content:center;gap:32px;margin-bottom:24px;flex-wrap:wrap}
    .footer-links a{color:#9CA3AF;text-decoration:none;font-size:14px}
    .footer-links a:hover{color:#fff}
    .social-links{display:flex;justify-content:center;gap:16px;margin-top:16px}
    .social-link{width:40px;height:40px;background:#374151;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#9CA3AF;text-decoration:none;transition:.2s}
    .social-link:hover{background:#0B57A4;color:#fff}
    .muted{color:#6B7280;font-size:13px}
    .transcript{white-space:pre-wrap;background:#FAFBFC;border:1px solid #E5E7EB;border-radius:12px;padding:16px;font-size:14px;color:#374151}
    @media (max-width:768px){
      .navbar{padding:0 20px}
      main{padding:20px}
      .upload-section,.risk-card,.detail-card{padding:24px}
      h1{font-size:24px}
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo-text">🛡️ 피싱탐지</div>
    <div class="nav-menu">
      <a href="/" class="nav-item">🏠 홈</a>
      <a href="/scan/voice" class="nav-item active">🎙️ 보이스피싱 스캔</a>
      <a href="/scan/message" class="nav-item">💬 문자피싱 스캔</a>
    </div>
  </nav>

  <main>
    <h1>보이스피싱 스캔</h1>
    <p class="description">녹음 파일을 업로드하면 AI가 실시간으로 분석하여 피싱 위험도를 판단합니다.</p>

    <div class="upload-section">
      <h2>🎧 음성 파일 업로드</h2>

      <label class="upload-area" id="drop-area">
        <input type="file" id="audio-file" accept=".mp3,.wav,.m4a,audio/*">
        <p id="upload-text">
          파일을 드래그하거나 클릭하여 선택하세요<br>
          <span class="muted">(지원: mp3, wav, m4a / 최대 20MB)</span>
        </p>
      </label>

      <div class="buttons">
        <button class="btn" id="upload-btn" disabled>분석 시작</button>
        <button class="btn btn-secondary" id="reset-btn">초기화</button>
      </div>

      <div class="progress-bar" id="progress-bar">
        <div class="progress" id="progress"></div>
      </div>
      <p class="muted" id="hint">※ 업로드 후 서버가 전사(STT) → RAG 분석을 수행합니다.</p>
      <p class="muted" id="error" style="color:#DC2626;display:none;"></p>
    </div>

    <div class="result-container" id="result-container">
      <div class="risk-card">
        <div class="risk-indicator">
          <div class="risk-circle low" id="risk-circle">
            <div>
              <span id="risk-percentage">0</span>%
              <div class="risk-label" id="risk-label">LOW RISK</div>
            </div>
          </div>
        </div>
        <h2 class="risk-title" id="risk-title">분석 대기 중</h2>
        <p class="risk-subtitle" id="risk-subtitle">업로드 후 결과가 표시됩니다.</p>
      </div>

      <div class="detail-card">
        <h3><span class="icon-badge">🗣️</span> 전사 결과</h3>
        <div id="transcript" class="transcript">-</div>
      </div>

      <div class="detail-card">
        <h3><span class="icon-badge">🔍</span> 탐지 근거</h3>
        <p id="evidence-text">-</p>
        <div style="margin-top:12px;" id="references"></div>
      </div>

      <div class="detail-card">
        <h3><span class="icon-badge">✅</span> 대응 방법</h3>
        <p id="solution-text">-</p>
      </div>

      <div class="action-buttons">
        <a href="tel:112" class="action-btn">
          <div class="action-btn-icon">🚨</div>
          <div class="action-btn-title">경찰 신고</div>
          <div class="action-btn-desc">112</div>
        </a>
        <a href="tel:1332" class="action-btn">
          <div class="action-btn-icon">🏦</div>
          <div class="action-btn-title">금감원 신고</div>
          <div class="action-btn-desc">1332</div>
        </a>
        <a href="#" class="action-btn" id="download-btn">
          <div class="action-btn-icon">📄</div>
          <div class="action-btn-title">리포트 저장</div>
          <div class="action-btn-desc">JSON 다운로드</div>
        </a>
        <a href="/" class="action-btn">
          <div class="action-btn-icon">🏠</div>
          <div class="action-btn-title">홈으로</div>
          <div class="action-btn-desc">메인 페이지</div>
        </a>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-links">
      <a href="#">회사소개</a><a href="#">서비스 이용약관</a><a href="#">개인정보처리방침</a><a href="#">고객지원</a>
    </div>
    <p style="color:#9CA3AF;font-size:14px;">© 2025 피싱탐지 — 모든 권리 보유</p>
    <div class="social-links">
      <a href="#" class="social-link">📧</a><a href="#" class="social-link">📞</a><a href="#" class="social-link">🌐</a>
    </div>
  </footer>

  <script>
    const fileInput = document.getElementById('audio-file');
    const uploadBtn = document.getElementById('upload-btn');
    const resetBtn = document.getElementById('reset-btn');
    const progressBar = document.getElementById('progress-bar');
    const progress = document.getElementById('progress');
    const uploadText = document.getElementById('upload-text');
    const dropArea = document.getElementById('drop-area');
    const resultContainer = document.getElementById('result-container');
    const errorEl = document.getElementById('error');

    const riskCircle = document.getElementById('risk-circle');
    const riskPercentage = document.getElementById('risk-percentage');
    const riskLabel = document.getElementById('risk-label');
    const riskTitle = document.getElementById('risk-title');
    const riskSubtitle = document.getElementById('risk-subtitle');

    const evidenceText = document.getElementById('evidence-text');
    const solutionText = document.getElementById('solution-text');
    const referencesDiv = document.getElementById('references');
    const transcriptEl = document.getElementById('transcript');
    const downloadBtn = document.getElementById('download-btn');

    let lastResponse = null;

    fileInput.addEventListener('change', handleFileSelect);
    resetBtn.addEventListener('click', resetForm);
    uploadBtn.addEventListener('click', uploadFile);
    downloadBtn.addEventListener('click', (e)=> {
      e.preventDefault();
      if (!lastResponse) return alert('아직 결과가 없습니다.');
      const blob = new Blob([JSON.stringify(lastResponse, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `voicephish_report_${(lastResponse._filename||'result').replace(/\W+/g,'_')}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    function handleFileSelect(e){
      const file = e.target.files[0];
      if (!file) return;
      const fileSizeMB = file.size / 1024 / 1024;
      if (fileSizeMB > 20){
        alert('파일 크기는 20MB를 초과할 수 없습니다.');
        fileInput.value = '';
        return;
      }
      uploadText.innerHTML = `선택된 파일: ${file.name}<br><span class="muted">${fileSizeMB.toFixed(2)}MB</span>`;
      uploadBtn.disabled = false;
      errorEl.style.display = 'none';
      errorEl.textContent = '';
    }

    function resetForm(){
      fileInput.value = '';
      uploadText.innerHTML = '파일을 드래그하거나 클릭하여 선택하세요<br><span class="muted">(지원: mp3, wav, m4a / 최대 20MB)</span>';
      progress.style.width = '0';
      progressBar.classList.remove('active');
      uploadBtn.disabled = true;
      resultContainer.classList.remove('show');
      dropArea.classList.remove('uploading');
      errorEl.style.display = 'none';
      errorEl.textContent = '';
      lastResponse = null;
      setRisk(null);
      evidenceText.textContent = '-';
      solutionText.textContent = '-';
      transcriptEl.textContent = '-';
      referencesDiv.innerHTML = '';
    }

    function uploadFile(){
      const file = fileInput.files[0];
      if (!file) return alert('파일을 선택하세요.');
      uploadBtn.disabled = true;
      dropArea.classList.add('uploading');
      progressBar.classList.add('active');
      errorEl.style.display = 'none';
      errorEl.textContent = '';

      const form = new FormData();
      form.append('file', file);

      // XHR로 업로드 진행률 표시
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/scan/voice', true);

      xhr.upload.addEventListener('progress', (e)=>{
        if (e.lengthComputable){
          const pct = Math.min(99, Math.round(e.loaded / e.total * 100));
          progress.style.width = pct + '%';
        }
      });

      xhr.onreadystatechange = ()=>{
        if (xhr.readyState === XMLHttpRequest.DONE){
          progress.style.width = '100%';
          dropArea.classList.remove('uploading');

          if (xhr.status >= 200 && xhr.status < 300){
            try{
              const data = JSON.parse(xhr.responseText);
              lastResponse = data;
              displayResult(data);
            }catch(err){
              showError('서버 응답 파싱 중 오류가 발생했습니다.');
            }
          }else{
            let msg = '업로드/분석 중 오류가 발생했습니다.';
            try{
              const res = JSON.parse(xhr.responseText);
              if (res && res.detail) msg = res.detail;
            }catch(_){}
            showError(msg);
          }
          uploadBtn.disabled = false;
        }
      };

      xhr.onerror = ()=> {
        showError('네트워크 오류가 발생했습니다.');
        uploadBtn.disabled = false;
      };

      xhr.send(form);
    }

    function showError(msg){
      errorEl.textContent = msg;
      errorEl.style.display = 'block';
    }

    function setRisk(prob){ // prob: 0..1 or null
      if (prob === null || prob === undefined || isNaN(prob)){
        riskCircle.className = 'risk-circle low';
        riskPercentage.textContent = '0';
        riskLabel.textContent = 'UNKNOWN';
        riskTitle.textContent = '근거 부족';
        riskSubtitle.textContent = '참고 자료가 부족하여 판별할 수 없습니다.';
        return;
      }
      const pct = Math.round(prob * 100);
      riskPercentage.textContent = pct.toString();

      if (pct >= 70){
        riskCircle.className = 'risk-circle high';
        riskLabel.textContent = 'HIGH RISK';
        riskTitle.textContent = '피싱 위험 높음';
        riskSubtitle.textContent = '보이스피싱 가능성이 매우 높습니다.';
      } else if (pct >= 40){
        riskCircle.className = 'risk-circle medium';
        riskLabel.textContent = 'MEDIUM RISK';
        riskTitle.textContent = '피싱 의심';
        riskSubtitle.textContent = '보이스피싱 가능성이 있습니다.';
      } else {
        riskCircle.className = 'risk-circle low';
        riskLabel.textContent = 'LOW RISK';
        riskTitle.textContent = '피싱 가능성 낮음';
        riskSubtitle.textContent = '보이스피싱 가능성이 낮습니다.';
      }
    }

    function displayResult(result){
      // 서버 스키마: is_phishing (0~1 or null), evidence, solution, reference_chunk_id[], _transcript, _filename
      const prob = (typeof result.is_phishing === 'number') ? result.is_phishing : null;
      setRisk(prob);

      evidenceText.textContent = result.evidence || '-';
      solutionText.textContent = result.solution || '-';
      transcriptEl.textContent = result._transcript || '(전사 결과 없음)';

      referencesDiv.innerHTML = '';
      (result.reference_chunk_id || []).forEach(id=>{
        const tag = document.createElement('span');
        tag.className = 'reference-tag';
        tag.textContent = id;
        referencesDiv.appendChild(tag);
      });

      resultContainer.classList.add('show');
      resultContainer.scrollIntoView({behavior:'smooth', block:'start'});
    }

    dropArea.addEventListener('dragover', (e)=>{ e.preventDefault(); dropArea.style.borderColor='#0B57A4'; });
    dropArea.addEventListener('dragleave', ()=>{ dropArea.style.borderColor='#D1D5DB'; });
    dropArea.addEventListener('drop', (e)=>{
      e.preventDefault();
      dropArea.style.borderColor='#D1D5DB';
      const files = e.dataTransfer.files;
      if (files && files.length > 0){
        fileInput.files = files;
        handleFileSelect({ target: fileInput });
      }
    });
  </script>
</body>
</html>
