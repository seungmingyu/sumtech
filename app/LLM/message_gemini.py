import os
from google import genai
from google.genai import types
from dotenv import load_dotenv

load_dotenv()
API_KEY = os.getenv("GEMINI_API_KEY")
if not API_KEY:
    raise RuntimeError("GEMINI_API_KEY missing in .env")

client = genai.Client(api_key=API_KEY)
MODEL = "gemini-2.5-flash"

def analyze_smishing_message(message_content: str, url_check_result: str):
    """
    ğŸ¯ ìŠ¤ë¯¸ì‹± ë¬¸ì íƒì§€ ë¶„ì„ í•¨ìˆ˜
    ì…ë ¥:
      - message_content: ë¬¸ì ë³¸ë¬¸ ë‚´ìš© (ì˜ˆ: "êµ­ë¯¼ì€í–‰ì…ë‹ˆë‹¤. ë³´ì•ˆë¬¸ì œ ë°œìƒ...")
      - url_check_result: URL ë¶„ì„ ê²°ê³¼ ("True" / "False" / "N/A")
    ì¶œë ¥:
      - Gemini ëª¨ë¸ì˜ ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸ (ì§€ì •ëœ í˜•ì‹)
    """

    contents = [
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(
                    text=f"""
ë‹¹ì‹ ì€ 'ìŠ¤ë¯¸ì‹±(Smishing)' íƒì§€ ì „ë¬¸ AI ë³´ì•ˆ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì œê³µë˜ëŠ” (1)ë¬¸ì ë©”ì‹œì§€ ë‚´ìš©ê³¼ (2)ë©”ì‹œì§€ ë‚´ URLì— ëŒ€í•œ ì‚¬ì „ ë¶„ì„ ê²°ê³¼ë¥¼ í† ëŒ€ë¡œ, ì¢…í•©ì ì¸ ìŠ¤ë¯¸ì‹± ìœ„í—˜ë„ë¥¼ í‰ê°€í•˜ê³ , ê·¼ê±°ë¥¼ ì œì‹œí•˜ë©°, ëŒ€ì²˜ ë°©ì•ˆì„ ì•ˆë‚´í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

### ì…ë ¥ ì •ë³´

1. **URL ë¶„ì„ ê²°ê³¼:** {url_check_result}
   * (ì„¤ëª…: `True`=ë¹„ì •ìƒ/ì•…ì„± URL íƒì§€, `False`=ì •ìƒ URLë¡œ íŒë‹¨, `N/A`=URL ì—†ìŒ)

2. **[ë¬¸ìë‚´ìš©ì‹œì‘]**
{message_content}
**[ë¬¸ìë‚´ìš©ì¢…ë£Œ]**

---

### ë¶„ì„ ì§€ì¹¨

* URL ë¶„ì„ ê²°ê³¼ê°€ `True`ì´ë©´ ë¬¸ì ë‚´ìš©ê³¼ ê´€ê³„ì—†ì´ ìœ„í—˜ë„ ë“±ê¸‰ì€ 'ìœ„í—˜' ë˜ëŠ” 'ë§¤ìš° ìœ„í—˜'ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
* URL ë¶„ì„ ê²°ê³¼ê°€ `False`ì´ë”ë¼ë„, ë¬¸ì ë‚´ìš©(ì˜ˆ: ê³µê³µê¸°ê´€/ê¸ˆìœµ/íƒë°° ì‚¬ì¹­, ì‹¬ë¦¬ì  ì••ë°•, ê°œì¸ì •ë³´ ìš”êµ¬, ì•± ì„¤ì¹˜ ìœ ë„)ì´ ì˜ì‹¬ìŠ¤ëŸ¬ìš°ë©´ ìœ„í—˜ë„ ë“±ê¸‰ì„ 'ì˜ì‹¬' ë˜ëŠ” 'ìœ„í—˜'ìœ¼ë¡œ íŒë‹¨í•´ì•¼ í•©ë‹ˆë‹¤.
* URL ë¶„ì„ ê²°ê³¼ê°€ `N/A`ì´ë©´ ìˆœìˆ˜í•˜ê²Œ ë¬¸ì ë‚´ìš©ë§Œìœ¼ë¡œ ìœ„í—˜ë„ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.

---

### ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ì¤€ìˆ˜)

## ğŸ›¡ï¸ ìŠ¤ë¯¸ì‹± ìœ„í—˜ë„ ë¶„ì„

**1. ìœ„í—˜ë„ ë“±ê¸‰:** [ì•ˆì „ / ì˜ì‹¬ / ìœ„í—˜ / ë§¤ìš° ìœ„í—˜ ì¤‘ í•˜ë‚˜]

**2. ìœ„í—˜ í™•ë¥ :** [0~100%ì˜ êµ¬ì²´ì ì¸ í™•ë¥ (%)]

**3. ë¶„ì„ ê·¼ê±°:**
* [ìœ„í—˜ë„ë¥¼ íŒë‹¨í•œ ì²« ë²ˆì§¸ í•µì‹¬ ê·¼ê±° (ì˜ˆ: URL ì‚¬ì „ ë¶„ì„ ê²°ê³¼ê°€ 'True' (ì•…ì„± ì˜ì‹¬))]
* [ë‘ ë²ˆì§¸ ê·¼ê±° (ì˜ˆ: [íƒë°°] ë°°ì†¡ì§€ ë¶ˆëª…í™•, ì£¼ì†Œì§€ í™•ì¸ì„ ì´ìœ ë¡œ URL í´ë¦­ ìœ ë„)]
* [ì„¸ ë²ˆì§¸ ê·¼ê±° (ì˜ˆ: ì¶œì²˜ê°€ ë¶ˆë¶„ëª…í•œ ë‹¨ì¶• URL ì‚¬ìš©)]

**4. ê¶Œê³  ëŒ€ì²˜ ë°©ì•ˆ:**
* [ê°€ì¥ ì¦‰ê°ì ì´ê³  ì¤‘ìš”í•œ ëŒ€ì²˜ ë°©ì•ˆ (ì˜ˆ: ë¬¸ì ë‚´ í¬í•¨ëœ URL ì ˆëŒ€ í´ë¦­ ê¸ˆì§€)]
* [ë‘ ë²ˆì§¸ ëŒ€ì²˜ ë°©ì•ˆ (ì˜ˆ: ì¦‰ì‹œ í•´ë‹¹ ë¬¸ì ë©”ì‹œì§€ ì‚­ì œ)]
* [ì„¸ ë²ˆì§¸ ëŒ€ì²˜ ë°©ì•ˆ (ì˜ˆ: ì•± ì„¤ì¹˜(.apk)ë¥¼ ìœ ë„í•˜ëŠ” ê²½ìš° ì ˆëŒ€ ì‘í•˜ì§€ ë§ ê²ƒ)]
                    """
                )
            ],
        )
    ]

    config = types.GenerateContentConfig(
        temperature=0.1,
        thinking_config=types.ThinkingConfig(thinking_budget=-1),
        system_instruction=[
            types.Part.from_text(
                text="í•œêµ­ì–´ë¡œë§Œ ë‹µë³€í•˜ê³ , ì§€ì •ëœ ì¶œë ¥ í˜•ì‹ ì™¸ ë¬¸ì¥ì€ ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆ."
            )
        ],
    )

    print("ğŸ” Gemini ìŠ¤ë¯¸ì‹± ë¶„ì„ ì¤‘...\n")
    output_text = ""
    for chunk in client.models.generate_content_stream(
        model=MODEL,
        contents=contents,
        config=config,
    ):
        if chunk.text:
            print(chunk.text, end="")
            output_text += chunk.text

    print("\n\nâœ… ë¶„ì„ ì™„ë£Œ")
    return output_text


# âœ… ì˜ˆì‹œ ì‹¤í–‰
if __name__ == "__main__":
    analyze_smishing_message(
        message_content="[êµ­ë¯¼ì€í–‰] ë³´ì•ˆì¸ì¦ ë§Œë£Œë¡œ ê³„ì •ì´ ì ê¹ë‹ˆë‹¤. ì•„ë˜ ë§í¬ë¡œ ì¸ì¦í•´ì£¼ì„¸ìš”. http://bank-verify.info",
        url_check_result="True"
    )
